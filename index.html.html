<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Revolut AI Spend Analyst</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #e5e7eb; /* Darker background for desktop contrast */
            color: #111827;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Gradients */
        .revolut-gradient-plus { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .revolut-gradient-premium { background: linear-gradient(135deg, #c026d3, #9333ea); }
        .revolut-gradient-metal { background: linear-gradient(135deg, #6b7280, #374151); }
        .revolut-gradient-ultra { background: linear-gradient(135deg, #fbbf24, #d97706); }
        
        /* Utilities */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Carousel Snapping */
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }

        /* Animations */
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        .animate-shimmer { animation: shimmer 2s infinite linear; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .animate-bounce-slow { animation: bounce-slow 3s infinite ease-in-out; }

        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        .animate-pulse-slow { animation: pulse-slow 3s infinite ease-in-out; }

        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .pop-in { animation: popIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes popIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
    </style>
</head>
<body class="m-0 p-0 h-screen w-screen overflow-hidden flex items-center justify-center">
    
    <div id="app" class="w-full h-full max-w-[420px] bg-white sm:h-[90vh] sm:rounded-[40px] sm:shadow-2xl relative flex flex-col overflow-hidden sm:border-[8px] sm:border-gray-900 box-border">
        </div>

    <script>
        // --- DATA & CONSTANTS ---
        const ICONS = {
            Generic: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,
            Coffee: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"/><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"/><line x1="6" y1="1" x2="6" y2="4"/><line x1="10" y1="1" x2="10" y2="4"/><line x1="14" y1="1" x2="14" y2="4"/></svg>`,
            Banknote: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="6" width="20" height="12" rx="2"/><circle cx="12" cy="12" r="2"/><path d="M6 12h.01M18 12h.01"/></svg>`,
            Plane: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.8 19.2L16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>`,
            Basket: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 2.45-4.9A2 2 0 0 1 7.24 3h9.52a2 2 0 0 1 1.8 1.1L21 9"/><path d="M3 9h18v10a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V9Z"/><path d="M8 12v5"/><path d="M12 12v5"/><path d="M16 12v5"/></svg>`,
            Cart: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></svg>`,
            Exchange: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>`,
            ChevronLeft: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>`,
            Avatar: `<svg width="32" height="32" viewBox="0 0 32 32" fill="none"><circle cx="16" cy="16" r="16" fill="#111827"/><path d="M16 8C13.7909 8 12 9.79086 12 12C12 14.2091 13.7909 16 16 16C18.2091 16 20 14.2091 20 12C20 9.79086 18.2091 8 16 8Z" fill="white"/><path d="M16 18C12.134 18 9 21.134 9 25H23C23 21.134 19.866 18 16 18Z" fill="white"/></svg>`,
            CheckCircle: `<svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#22C55E" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`
        };

        const TRANSACTIONS = [
            { id: '5', rawText: 'AMZN_US_MKTPLC_FX', cleanName: 'Amazon US', amount: -55.00, icon: 'Cart', color: '#FF9900', feeStandard: 2.50, timestamp: 'Today, 14:02', isIdentified: true },
            { id: '7', rawText: 'CAFE_LORE_DUB_FX', cleanName: 'Artisan Cafe', amount: -16.00, icon: 'Coffee', color: '#6F4E37', feeStandard: 1.50, timestamp: 'Today, 08:45' },
            { id: '1', rawText: 'NYC_STARBUCKS_FX', cleanName: 'Starbucks', amount: -12.50, icon: 'Coffee', color: '#00704A', feeStandard: 1.50, timestamp: 'Today, 11:30' },
            { id: '8', rawText: 'SNAP_FITNESS_DUB', cleanName: 'Snap Fitness', amount: -39.00, icon: 'Generic', color: '#EF4444', feeStandard: 0, points: 39, benefitText: '+39 RevPoints', timestamp: 'Oct 22, 06:00' },
            { id: '2', rawText: 'ATM_WDR_NON_NTWK', cleanName: 'ATM Withdrawal', amount: -100.00, icon: 'Banknote', color: '#059669', feeStandard: 6.00, benefitText: 'Free', timestamp: 'Yesterday, 18:45' },
            { id: '3', rawText: 'RYANAIR_STN_RTN', cleanName: 'Ryanair', amount: -118.00, icon: 'Plane', color: '#073590', feeStandard: 0, benefitText: 'Covered âœ…', timestamp: 'Yesterday, 09:12' },
            { id: '4', rawText: 'TESCO_EXP_882_IE', cleanName: 'Tesco Express', amount: -38.00, icon: 'Basket', color: '#00539F', feeStandard: 0, points: 38, benefitText: '+38 RevPoints', timestamp: 'Oct 24, 20:15' },
            { id: '6', rawText: 'WEEKEND_FX_TRF', cleanName: 'Exchange', amount: -200.00, icon: 'Exchange', color: '#7C3AED', feeStandard: 10.00, benefitText: 'Waived', timestamp: 'Oct 23, 14:55' }
        ];

        const PLANS = [
            { id: 'plus', name: 'Plus', price: 'â‚¬3.99', gradientClass: 'revolut-gradient-plus', features: ['Basic FX Limit', 'Standard Support', 'Purchase Protection'], benefitBox: '+ 10 more benefits included', cta: 'Start Plus Trial' },
            { id: 'premium', name: 'Premium', price: 'â‚¬8.99', badge: 'Reclaim â‚¬21.50 monthly', gradientClass: 'revolut-gradient-premium', features: ['Unlimited FX', 'Travel Insurance', 'Priority Support'], benefitBox: 'Everything in Plus + 15 more benefits', cta: 'Start Premium Trial' },
            { id: 'metal', name: 'Metal', price: 'â‚¬15.99', gradientClass: 'revolut-gradient-metal', features: ['1% Cashback', 'Device Insurance'], benefitBox: 'Everything in Premium + 20 more benefits', cta: 'Start Metal Trial' },
            { id: 'ultra', name: 'Ultra', price: 'â‚¬55.00', gradientClass: 'revolut-gradient-ultra', features: ['Lifestyle Concierge', 'Lounge Access'], benefitBox: 'Everything in Metal + 25 more benefits', cta: 'Start Ultra Trial' }
        ];

        // --- STATE MANAGEMENT ---
        const state = {
            phase: 'MESSY_FEED', // 'MESSY_FEED', 'ANALYST_REPORT', 'PLAN_CAROUSEL', 'TRIAL_SUCCESS'
            isAnalyzing: false,
            analyzed: false,
            progress: 0,
            currentPlanIndex: 0
        };

        const setState = (updates) => {
            Object.assign(state, updates);
            render();
        };

        // --- HELPERS ---
        function renderIcon(iconName, color, forceActive = false) {
            const iconSvg = ICONS[iconName] || ICONS.Generic;
            const active = forceActive;
            
            return `
                <div class="w-12 h-12 rounded-[18px] flex items-center justify-center transition-all duration-700 shadow-sm overflow-hidden relative flex-shrink-0"
                     style="background-color: ${active ? color : '#F3F4F6'}; color: ${active ? '#FFFFFF' : '#9CA3AF'}; box-shadow: ${active ? `0 8px 16px -4px ${color}40` : 'none'}">
                    <div class="${active ? 'scale-110' : 'scale-100 transition-transform'}">
                        ${iconSvg}
                    </div>
                    ${!active && state.isAnalyzing ? `<div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/40 to-transparent animate-shimmer"></div>` : ''}
                </div>
            `;
        }

        function startAnalysis() {
            setState({ isAnalyzing: true, progress: 0 });
            let currentProgress = 0;
            const interval = setInterval(() => {
                currentProgress += 2;
                state.progress = currentProgress;
                
                const progressEl = document.getElementById('progress-circle');
                if (progressEl) {
                    progressEl.style.clipPath = `inset(0 0 0 ${100 - currentProgress}%)`;
                }

                if (currentProgress >= 100) {
                    clearInterval(interval);
                    setTimeout(() => {
                        setState({ analyzed: true, isAnalyzing: false });
                    }, 300);
                }
            }, 40);
        }

        function scrollToPlan(index) {
            state.currentPlanIndex = index;
            const container = document.getElementById('carousel-container');
            if (container) {
                const card = container.children[index];
                container.scrollTo({
                    left: card.offsetLeft - (container.offsetWidth - card.offsetWidth) / 2,
                    behavior: 'smooth'
                });
            }
            updateCarouselUI();
        }

        function activatePlan(index) {
            // New function to handle the click from the carousel card
            state.currentPlanIndex = index;
            setState({ phase: 'TRIAL_SUCCESS' });
        }

        function updateCarouselUI() {
            const dots = document.querySelectorAll('.carousel-dot');
            dots.forEach((dot, idx) => {
                if (idx === state.currentPlanIndex) {
                    dot.className = "carousel-dot h-2.5 rounded-full transition-all duration-300 w-10 bg-blue-600 shadow-md shadow-blue-200";
                } else {
                    dot.className = "carousel-dot h-2.5 rounded-full transition-all duration-300 w-2.5 bg-gray-300";
                }
            });

            const leftArrow = document.getElementById('carousel-left');
            const rightArrow = document.getElementById('carousel-right');
            if (leftArrow) leftArrow.style.opacity = state.currentPlanIndex === 0 ? '0' : '1';
            if (rightArrow) rightArrow.style.opacity = state.currentPlanIndex === PLANS.length - 1 ? '0' : '1';
        }

        // --- DATE HELPER FOR FINAL SCREEN ---
        function getDates() {
            const today = new Date();
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 7);
            
            const options = { day: 'numeric', month: 'short' };
            return {
                today: today.toLocaleDateString('en-GB', options), // e.g. "5 Jan"
                nextWeek: nextWeek.toLocaleDateString('en-GB', options) // e.g. "12 Jan"
            };
        }

        // --- VIEW RENDERERS ---
        function renderMessyFeed() {
            const listHtml = TRANSACTIONS.map(tx => {
                const isVisibleAsClean = state.analyzed || tx.isIdentified;
                return `
                    <div class="relative group bg-white p-4.5 rounded-[28px] transition-all duration-500 cursor-pointer flex items-center justify-between border border-transparent shadow-[0_4px_12px_rgba(0,0,0,0.025)] hover:shadow-[0_12px_28px_rgba(0,0,0,0.07)] hover:scale-[1.02] active:scale-[0.98] overflow-hidden ${state.isAnalyzing && !isVisibleAsClean ? 'opacity-50 blur-[0.5px]' : 'opacity-100 blur-0'}">
                        <div class="flex items-center gap-4 relative z-10 overflow-hidden flex-1">
                            ${renderIcon(tx.icon, tx.color, true)}
                            <div class="flex flex-col overflow-hidden">
                                <span class="font-black text-[17px] leading-tight transition-all duration-700 truncate ${isVisibleAsClean ? 'text-gray-900' : 'text-gray-400 italic'}">
                                    ${isVisibleAsClean ? tx.cleanName : tx.rawText}
                                </span>
                                <span class="text-[12px] text-gray-400 font-bold mt-0.5 tracking-tight truncate">${tx.timestamp}</span>
                            </div>
                        </div>
                        <div class="text-right relative z-10 flex-shrink-0 ml-4 flex flex-col items-end justify-center min-w-[80px]">
                            <span class="font-black text-[18px] text-gray-900 block tracking-tight">${tx.amount.toFixed(2).replace('-', '-â‚¬')}</span>
                            ${state.analyzed && tx.feeStandard > 0 ? `
                                <div class="flex justify-end mt-1 fade-in">
                                    <span class="text-[9px] text-red-500 font-black px-2 py-0.5 bg-red-50 rounded-lg border border-red-100 uppercase tracking-tighter whitespace-nowrap">-â‚¬${tx.feeStandard.toFixed(2)} Fee</span>
                                </div>
                            ` : state.analyzed && tx.points ? `
                                <div class="flex justify-end mt-1 fade-in">
                                    <span class="text-[9px] text-indigo-500 font-black px-2 py-0.5 bg-indigo-50 rounded-lg border border-indigo-100 uppercase tracking-tighter whitespace-nowrap">+${tx.points} Pts</span>
                                </div>
                            ` : state.analyzed && tx.benefitText === 'Covered âœ…' ? `
                                <div class="flex justify-end mt-1 fade-in">
                                    <span class="text-[9px] text-blue-500 font-black px-2 py-0.5 bg-blue-50 rounded-lg border border-blue-100 uppercase tracking-tighter whitespace-nowrap">Insurance</span>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            const heroHtml = !state.analyzed && !state.isAnalyzing ? `
                <div onclick="startAnalysis()" class="relative overflow-hidden bg-black rounded-[32px] p-6 shadow-2xl transition-all hover:scale-[1.01] active:scale-[0.99] group cursor-pointer border border-white/5">
                    <div class="absolute -top-10 -right-10 w-32 h-32 bg-blue-600 rounded-full blur-[60px] opacity-40 group-hover:opacity-60 transition-opacity"></div>
                    <div class="absolute -bottom-10 -left-10 w-32 h-32 bg-purple-600 rounded-full blur-[60px] opacity-40 group-hover:opacity-60 transition-opacity"></div>
                    <div class="relative z-10 flex flex-col gap-4">
                        <div class="flex items-center gap-2">
                            <span class="bg-blue-600 text-white text-[9px] font-black px-2 py-0.5 rounded-full uppercase tracking-widest">Live AI</span>
                        </div>
                        <div class="space-y-1">
                            <h2 class="text-2xl font-black text-white leading-tight tracking-tight">AI spotted <span class="text-blue-400">â‚¬21.50</span> in hidden fees.</h2>
                            <p class="text-sm text-gray-400 font-medium leading-snug">We identified foreign transaction costs that could be waived.</p>
                        </div>
                        <button class="mt-2 w-full bg-white text-black py-4 rounded-2xl font-black text-base shadow-[0_10px_20px_rgba(255,255,255,0.1)] hover:bg-gray-100 transition-all transform flex items-center justify-center gap-2 active:scale-95">
                            AI Spend Analyzer
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"/></svg>
                        </button>
                    </div>
                </div>
            ` : state.isAnalyzing ? `
                <div class="bg-white p-8 rounded-[32px] border border-gray-100 flex flex-col items-center gap-6 shadow-sm animate-pulse-slow">
                    <div class="relative w-20 h-20 flex items-center justify-center">
                        <div class="absolute inset-0 border-4 border-blue-50 rounded-full"></div>
                        <div id="progress-circle" class="absolute inset-0 border-4 border-blue-600 rounded-full transition-all duration-300 shadow-[0_0_15px_rgba(37,99,235,0.2)]"
                             style="clip-path: inset(0 0 0 ${100 - state.progress}%); transform: rotate(-90deg)"></div>
                        <div class="text-3xl">ðŸ¤–</div>
                    </div>
                    <div class="flex flex-col items-center gap-2 text-center">
                        <p class="text-xl font-black text-gray-900 tracking-tight">AI Analyst identifying...</p>
                        <p class="text-sm text-gray-400 font-medium max-w-[220px]">Cleaning raw merchant data and calculating cashback opportunities</p>
                    </div>
                </div>
            ` : `
                <div class="bg-white border border-green-100 p-6 rounded-[32px] shadow-[0_15px_30px_rgba(0,0,0,0.03)] space-y-4 fade-in relative overflow-hidden group">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-green-500/5 rounded-full blur-2xl -translate-y-1/2 translate-x-1/2"></div>
                    <div class="flex items-start gap-4 relative z-10">
                        <div class="w-14 h-14 bg-green-500/10 rounded-2xl flex items-center justify-center text-3xl shadow-inner border border-green-500/10 flex-shrink-0">âœ¨</div>
                        <div class="flex-1">
                            <p class="font-black text-gray-900 text-lg leading-tight">Insight Ready</p>
                            <p class="text-[15px] text-gray-600 font-medium mt-1 leading-relaxed">We found <span class="text-green-600 font-black">â‚¬21.50</span> in monthly savings currently being wasted.</p>
                        </div>
                    </div>
                    <button onclick="setState({ phase: 'ANALYST_REPORT' })" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black transition active:scale-[0.98] shadow-[0_10px_20px_rgba(37,99,235,0.2)] hover:shadow-blue-500/40 relative z-10">
                        View Full Report
                    </button>
                </div>
            `;

            return `
                <div class="flex flex-col h-full bg-[#F5F7F9]">
                    <header class="p-4 flex items-center justify-between bg-white border-b border-gray-100 sticky top-0 z-30">
                        <div class="flex items-center gap-3">
                            <div class="relative flex-shrink-0">${ICONS.Avatar}
                                <div class="absolute -bottom-1 -right-1 w-3.5 h-3.5 bg-green-500 border-2 border-white rounded-full shadow-sm"></div>
                            </div>
                            <span class="font-extrabold text-2xl tracking-tight text-gray-900 truncate">Transactions</span>
                        </div>
                        <button class="p-2 hover:bg-gray-100 rounded-full transition-colors flex-shrink-0">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                        </button>
                    </header>
                    <main class="flex-1 overflow-y-auto px-4 py-4 space-y-6">
                        ${heroHtml}
                        <div class="space-y-4 pb-12">
                            <div class="flex items-center justify-between px-1">
                                <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.25em]">Recent Activity</p>
                                <button class="text-blue-600 text-[11px] font-black uppercase tracking-widest hover:underline flex-shrink-0">See all</button>
                            </div>
                            <div class="grid gap-3.5">${listHtml}</div>
                        </div>
                    </main>
                </div>
            `;
        }

        function renderAnalystReport() {
            const reportListHtml = TRANSACTIONS.map(tx => `
                <div class="bg-white p-5 rounded-[28px] shadow-sm border border-transparent hover:border-gray-100 transition-all flex items-center justify-between group cursor-pointer hover:shadow-md active:scale-[0.99] overflow-hidden">
                    <div class="flex items-center gap-3.5 w-1/2 overflow-hidden">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center shadow-inner border flex-shrink-0" style="background-color: ${tx.color}; color: #FFFFFF; border-color: ${tx.color}20">
                            ${ICONS[tx.icon] || ICONS.Generic}
                        </div>
                        <div class="flex flex-col overflow-hidden">
                            <span class="font-black text-[14px] text-gray-900 truncate tracking-tight">${tx.cleanName}</span>
                            <span class="text-[10px] text-gray-400 font-bold truncate">${tx.amount.toFixed(2)}</span>
                        </div>
                    </div>
                    <div class="flex-1 flex justify-between items-center gap-2">
                        <div class="flex-1 text-center">
                            <span class="text-[13px] font-black ${tx.feeStandard > 0 ? 'text-red-500' : 'text-gray-300'} whitespace-nowrap">
                                ${tx.feeStandard > 0 ? `-â‚¬${tx.feeStandard.toFixed(2)}` : 'â‚¬0.00'}
                            </span>
                        </div>
                        <div class="flex-1 flex justify-center">
                            ${tx.benefitText === 'Waived' ? `<span class="bg-green-500 text-white px-2.5 py-1 rounded-lg text-[9px] font-black uppercase tracking-wider shadow-sm shadow-green-200 whitespace-nowrap">Waived</span>` : 
                              tx.points ? `<span class="text-[11px] font-black text-blue-600 whitespace-nowrap">+${tx.points} Pts</span>` : 
                              `<span class="text-[11px] font-black text-green-600 whitespace-nowrap">${tx.benefitText || 'Included'}</span>`}
                        </div>
                    </div>
                </div>
            `).join('');

            return `
                <div class="flex flex-col h-full bg-[#F5F7F9]">
                    <header class="p-4 flex items-center justify-between border-b border-gray-100 bg-white sticky top-0 z-30">
                        <button onclick="setState({ phase: 'MESSY_FEED', analyzed: false, progress: 0 })" class="p-2 hover:bg-gray-100 rounded-full transition active:scale-90 flex-shrink-0">${ICONS.ChevronLeft}</button>
                        <h1 class="font-black text-xl tracking-tight truncate">Analyst Report</h1>
                        <div class="w-10 flex-shrink-0"></div>
                    </header>
                    <main class="flex-1 overflow-y-auto px-4 pb-20">
                        <div class="py-12 px-6 text-center space-y-3">
                            <p class="text-gray-400 font-black text-[11px] uppercase tracking-[0.25em]">Monthly Waste Detected</p>
                            <h2 class="text-6xl font-black text-gray-900 tracking-tighter">â‚¬21.50</h2>
                            <p class="text-[15px] text-gray-500 font-medium pt-3 leading-relaxed max-w-[280px] mx-auto">Our AI found specific fees that are <span class="text-gray-900 font-bold">100% avoidable</span> on Premium.</p>
                        </div>
                        <div class="space-y-6">
                            <div class="flex items-center justify-between px-6">
                                <div class="w-1/2 text-[10px] font-black text-gray-400 uppercase tracking-widest truncate">Merchant</div>
                                <div class="flex-1 flex justify-between gap-2">
                                    <div class="text-[10px] font-black text-red-500 uppercase tracking-widest text-center flex-1">Standard</div>
                                    <div class="text-[10px] font-black text-blue-600 uppercase tracking-widest text-center flex-1">Premium</div>
                                </div>
                            </div>
                            <div class="grid gap-3">${reportListHtml}</div>
                        </div>
                    </main>
                    <footer class="p-5 bg-white border-t border-gray-100 sticky bottom-0 z-40">
                        <button onclick="setState({ phase: 'PLAN_CAROUSEL' })" class="w-full bg-blue-600 text-white py-5 rounded-3xl font-black text-lg transition shadow-[0_15px_30px_rgba(37,99,235,0.3)] active:scale-[0.98] hover:bg-blue-700">
                            Stop Wasting fees / Upgrade Now
                        </button>
                    </footer>
                </div>
            `;
        }

        function renderPlanCarousel() {
            const planCardsHtml = PLANS.map((plan, idx) => `
                <div class="flex-none w-[calc(100vw-3.5rem)] max-w-[360px] snap-center rounded-[44px] p-9 sm:p-11 flex flex-col justify-between text-white shadow-2xl ${plan.gradientClass} relative h-[78vh] min-h-[550px] max-h-[660px] overflow-hidden transform transition-all duration-500 group border border-white/10">
                    <div class="absolute -top-24 -right-24 w-64 h-64 bg-white/10 rounded-full blur-[80px] group-hover:scale-125 transition-transform duration-1000"></div>
                    ${plan.badge ? `<div class="absolute top-6 right-6 bg-white/95 backdrop-blur text-gray-900 text-[10px] font-black px-4 py-2 rounded-full shadow-lg uppercase tracking-wider z-10 border border-black/5 animate-bounce-slow">${plan.badge}</div>` : ''}
                    <div class="space-y-10 relative z-10">
                        <div>
                            <h3 class="text-5xl font-black tracking-tighter leading-none drop-shadow-md truncate">${plan.name}</h3>
                            <div class="flex items-baseline gap-2 mt-4 overflow-hidden">
                                <span class="text-3xl font-black opacity-95 whitespace-nowrap">${plan.price}</span>
                                <span class="text-base font-bold opacity-75 whitespace-nowrap">/ month</span>
                            </div>
                        </div>
                        <div class="space-y-5">
                            ${plan.features.map(feat => `
                                <div class="flex items-start gap-4 fade-in">
                                    <div class="w-6.5 h-6.5 flex-shrink-0 flex items-center justify-center bg-white/20 rounded-full border border-white/20 shadow-inner">
                                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4"><polyline points="20 6 9 17 4 12"/></svg>
                                    </div>
                                    <span class="font-bold text-[17px] leading-snug tracking-tight opacity-95 line-clamp-2">${feat}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="space-y-6 relative z-10 mt-auto">
                        <div class="bg-white/15 backdrop-blur-md p-5 rounded-3xl border border-white/20 shadow-inner">
                            <p class="text-[12px] font-black text-center uppercase tracking-[0.15em] leading-relaxed text-white line-clamp-2">${plan.benefitBox}</p>
                        </div>
                        <button onclick="activatePlan(${idx})" class="w-full bg-white text-gray-900 py-5.5 rounded-3xl font-black text-xl shadow-2xl transition-all active:scale-[0.96] hover:bg-gray-50 ring-offset-2 ring-white/20 focus:ring-4 truncate">
                            ${plan.cta}
                        </button>
                    </div>
                </div>
            `).join('');

            const dotsHtml = PLANS.map((_, idx) => `
                <button onclick="scrollToPlan(${idx})" class="carousel-dot h-2.5 rounded-full transition-all duration-300 ${idx === state.currentPlanIndex ? 'w-10 bg-blue-600 shadow-md shadow-blue-200' : 'w-2.5 bg-gray-300'}"></button>
            `).join('');

            return `
                <div class="flex flex-col h-full bg-white">
                    <header class="p-4 flex items-center justify-between border-b bg-white z-10 sticky top-0">
                        <button onclick="setState({ phase: 'ANALYST_REPORT' })" class="p-2 hover:bg-gray-100 rounded-full transition active:scale-90 flex-shrink-0">${ICONS.ChevronLeft}</button>
                        <h1 class="font-black text-xl tracking-tight text-center flex-1 truncate">Upgrade Plan</h1>
                        <div class="w-10 flex-shrink-0"></div>
                    </header>
                    <main class="flex-1 flex flex-col justify-center relative overflow-hidden bg-[#F9FAFB]">
                        <div class="absolute inset-x-0 top-1/2 -translate-y-1/2 flex justify-between px-2 z-20 pointer-events-none">
                            <button id="carousel-left" onclick="scrollToPlan(state.currentPlanIndex - 1)" class="p-3 bg-white/95 backdrop-blur shadow-2xl rounded-full text-gray-800 active:scale-90 transition pointer-events-auto border border-gray-100" style="opacity: 0">
                                ${ICONS.ChevronLeft}
                            </button>
                            <button id="carousel-right" onclick="scrollToPlan(state.currentPlanIndex + 1)" class="p-3 bg-white/95 backdrop-blur shadow-2xl rounded-full text-gray-800 active:scale-90 transition rotate-180 pointer-events-auto border border-gray-100">
                                ${ICONS.ChevronLeft}
                            </button>
                        </div>
                        <div id="carousel-container" class="overflow-x-auto hide-scrollbar snap-x snap-mandatory flex gap-5 px-6 py-4 items-center h-full scroll-smooth">
                            ${planCardsHtml}
                        </div>
                        <div class="absolute bottom-6 left-1/2 -translate-x-1/2 flex gap-2.5 z-20">${dotsHtml}</div>
                    </main>
                    <footer class="p-4 py-10 text-center border-t bg-white">
                        <p class="text-[11px] font-black text-gray-400 uppercase tracking-[0.3em] opacity-80">7-day free trial â€¢ Cancel anytime</p>
                    </footer>
                </div>
            `;
        }

        // --- NEW FINAL SUCCESS SCREEN ---
        function renderSuccessScreen() {
            const plan = PLANS[state.currentPlanIndex];
            const dates = getDates();
            
            return `
                <div class="flex flex-col h-full bg-white fade-in relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-[40vh] ${plan.gradientClass} opacity-10 rounded-b-[60px]"></div>
                    
                    <header class="p-4 flex items-center justify-between z-10">
                        <button onclick="setState({ phase: 'PLAN_CAROUSEL' })" class="p-2 hover:bg-gray-100 rounded-full transition active:scale-90">${ICONS.ChevronLeft}</button>
                        <div class="w-10"></div>
                    </header>

                    <main class="flex-1 flex flex-col items-center justify-center p-6 text-center space-y-8 z-10">
                        
                        <div class="relative w-24 h-24 flex items-center justify-center">
                            <div class="absolute inset-0 bg-green-50 rounded-full scale-125 animate-pulse-slow"></div>
                            <div class="bg-white rounded-full p-2 shadow-xl border-4 border-green-50 pop-in">
                                ${ICONS.CheckCircle}
                            </div>
                        </div>

                        <div class="space-y-2">
                            <h1 class="text-3xl font-black text-gray-900 tracking-tight">Trial Activated!</h1>
                            <p class="text-gray-500 font-medium">Welcome to Revolut <span class="text-black font-bold">${plan.name}</span></p>
                        </div>

                        <div class="w-full bg-white border border-gray-100 shadow-xl rounded-[32px] p-6 space-y-6 relative overflow-hidden">
                             <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-blue-500 to-transparent opacity-20"></div>

                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-black text-white flex items-center justify-center font-bold text-xs shadow-lg z-10">
                                    Now
                                </div>
                                <div class="flex-1 text-left">
                                    <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Trial Starts</p>
                                    <p class="text-lg font-black text-gray-900">${dates.today}</p>
                                </div>
                                <div class="text-right">
                                    <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-black uppercase tracking-wide">Free</span>
                                </div>
                            </div>

                            <div class="absolute left-[39px] top-[50px] bottom-[50px] w-0.5 bg-gray-100 -z-0"></div>

                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-white border-2 border-gray-200 text-gray-400 flex items-center justify-center font-bold text-xs z-10">
                                    7d
                                </div>
                                <div class="flex-1 text-left">
                                    <p class="text-xs font-black text-gray-400 uppercase tracking-widest">Trial Ends</p>
                                    <p class="text-lg font-black text-gray-900">${dates.nextWeek}</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-bold text-gray-400">Recurring</p>
                                    <p class="text-lg font-black text-gray-900">${plan.price}</p>
                                </div>
                            </div>
                        </div>

                        <p class="text-xs text-gray-400 max-w-xs mx-auto leading-relaxed">
                            You won't be charged until the trial ends. We'll send you a reminder 2 days before.
                        </p>

                    </main>

                    <footer class="p-6 pb-8 bg-white z-10">
                        <button onclick="setState({ phase: 'MESSY_FEED', analyzed: false, progress: 0 })" class="w-full bg-black text-white py-5 rounded-3xl font-black text-lg shadow-2xl active:scale-[0.98] transition">
                            Done
                        </button>
                    </footer>
                </div>
            `;
        }

        // --- RENDER ORCHESTRATOR ---
        function render() {
            const app = document.getElementById('app');
            let content = '';

            switch(state.phase) {
                case 'MESSY_FEED':
                    content = renderMessyFeed();
                    break;
                case 'ANALYST_REPORT':
                    content = renderAnalystReport();
                    break;
                case 'PLAN_CAROUSEL':
                    content = renderPlanCarousel();
                    break;
                case 'TRIAL_SUCCESS':
                    content = renderSuccessScreen();
                    break;
            }

            app.innerHTML = content;

            // Post-render lifecycle
            if (state.phase === 'PLAN_CAROUSEL') {
                const container = document.getElementById('carousel-container');
                if (container) {
                    // Force scroll to current plan
                    const card = container.children[state.currentPlanIndex];
                    if(card) {
                        // Use timeout to allow layout calculation
                        setTimeout(() => {
                             container.scrollTo({
                                left: card.offsetLeft - (container.offsetWidth - card.offsetWidth) / 2,
                                behavior: 'auto'
                            });
                        }, 0);
                    }

                    container.addEventListener('scroll', () => {
                        const scrollLeft = container.scrollLeft;
                        const containerCenter = scrollLeft + container.offsetWidth / 2;
                        
                        let activeIndex = 0;
                        let minDistance = Infinity;

                        Array.from(container.children).forEach((child, idx) => {
                            const center = child.offsetLeft + child.offsetWidth / 2;
                            const dist = Math.abs(containerCenter - center);
                            if (dist < minDistance) {
                                minDistance = dist;
                                activeIndex = idx;
                            }
                        });

                        if (activeIndex !== state.currentPlanIndex) {
                            state.currentPlanIndex = activeIndex;
                            updateCarouselUI();
                        }
                    });
                    updateCarouselUI();
                }
            }
        }

        // --- INITIALIZE ---
        render();

        // Export globals for inline event handlers
        window.setState = setState;
        window.startAnalysis = startAnalysis;
        window.scrollToPlan = scrollToPlan;
        window.activatePlan = activatePlan;

    </script>
</body>
</html>